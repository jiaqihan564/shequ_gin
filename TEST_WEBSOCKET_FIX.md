# WebSocket ä¿®å¤æµ‹è¯•æŒ‡å—

## ğŸ“‹ å·²å®Œæˆçš„ä¿®å¤

### å‰ç«¯ä¿®å¤ï¼ˆå·²å®Œæˆï¼‰âœ…
1. âœ… ç§»é™¤ LoginView ä¸­çš„é‡å¤åˆå§‹åŒ–
2. âœ… æ·»åŠ å†å²æ¶ˆæ¯åŠ è½½æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤åŠ è½½
3. âœ… åœ¨èŠå¤©é¡µé¢æ·»åŠ æ¶ˆæ¯æ£€æŸ¥

### åç«¯ä¿®å¤ï¼ˆå·²å®Œæˆï¼‰âœ…
1. âœ… ä¿®å¤ WebSocket `close of closed channel` panic
2. âœ… æ·»åŠ æŒ‡é’ˆæ¯”è¾ƒé˜²æ­¢é‡å¤å…³é—­ channel
3. âœ… ç¼–è¯‘æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶

## ğŸš€ å¯åŠ¨åç«¯æœåŠ¡å™¨

### æ–¹æ³• 1: ä½¿ç”¨å¯åŠ¨è„šæœ¬
```bash
cd shequ_gin
.\start-server.bat
```

### æ–¹æ³• 2: æ‰‹åŠ¨å¯åŠ¨
```bash
cd shequ_gin
.\build\app.exe
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯• 1: æ­£å¸¸ç™»å½•å’ŒèŠå¤©
1. å¯åŠ¨åç«¯æœåŠ¡å™¨
2. æ‰“å¼€å‰ç«¯ï¼Œç™»å½•è´¦å·
3. è¿›å…¥èŠå¤©å®¤
4. å‘é€å‡ æ¡æ¶ˆæ¯
5. âœ… **é¢„æœŸ**: æ¶ˆæ¯æ­£å¸¸å‘é€å’Œæ¥æ”¶ï¼Œæ— é”™è¯¯

### æµ‹è¯• 2: å¿«é€Ÿåˆ·æ–°é¡µé¢ï¼ˆä¿®å¤é‡ç‚¹ï¼‰
1. åœ¨èŠå¤©å®¤é¡µé¢
2. å¿«é€ŸæŒ‰ F5 åˆ·æ–°é¡µé¢ï¼ˆ3-5æ¬¡ï¼‰
3. è§‚å¯Ÿåç«¯æ—¥å¿—
4. âœ… **é¢„æœŸ**: 
   - å‰ç«¯æ­£å¸¸é‡è¿
   - åç«¯æ—¥å¿—æ˜¾ç¤º "Replaced old connection"
   - **ä¸å†å‡ºç° panic é”™è¯¯**

### æµ‹è¯• 3: åœ¨èŠå¤©é¡µé¢é—´åˆ‡æ¢
1. è¿›å…¥ "èŠå¤©å®¤" (/chatroom)
2. åˆ‡æ¢åˆ° "å¼¹å¹•èŠå¤©å®¤" (/danmaku-chat)
3. å†åˆ‡æ¢å› "èŠå¤©å®¤"
4. é‡å¤å‡ æ¬¡
5. âœ… **é¢„æœŸ**:
   - ä¸ä¼šå‡ºç°é‡å¤çš„æ–­å¼€è¿æ¥æ—¥å¿—
   - æ¶ˆæ¯ä¿æŒä¸€è‡´
   - WebSocket è¿æ¥ä¿æŒæ´»è·ƒ

### æµ‹è¯• 4: å¤šæ ‡ç­¾é¡µåŒæ—¶ç™»å½•ï¼ˆé«˜çº§ï¼‰
1. åœ¨æµè§ˆå™¨æ‰“å¼€ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µï¼Œç™»å½•
2. å¤åˆ¶æ ‡ç­¾é¡µï¼ˆCtrl+Shift+T æˆ–å³é”®å¤åˆ¶ï¼‰
3. åœ¨ä¸¤ä¸ªæ ‡ç­¾é¡µéƒ½è¿›å…¥èŠå¤©å®¤
4. è§‚å¯Ÿåç«¯è¡Œä¸º
5. âœ… **é¢„æœŸ**:
   - æœ€æ–°çš„è¿æ¥ä¿æŒæ´»è·ƒ
   - æ—§è¿æ¥è¢«æ­£ç¡®æ›¿æ¢
   - æ—  panic é”™è¯¯

## ğŸ“Š ç›‘æ§åç«¯æ—¥å¿—

### æ­£å¸¸æ—¥å¿—ç¤ºä¾‹
```
[INFO] Client connected userID=42 username=testuser
[INFO] Client connected userID=42 username=testuser
[INFO] Replaced old connection userID=42
[INFO] Client disconnected userID=42
```

### âŒ ä¿®å¤å‰çš„é”™è¯¯æ—¥å¿—ï¼ˆä¸åº”å†å‡ºç°ï¼‰
```
panic: close of closed channel
goroutine 109 [running]:
gin/internal/handlers.(*ConnectionHub).run(...)
```

## ğŸ” æ£€æŸ¥ç‚¹

### å‰ç«¯æ—¥å¿—ï¼ˆæµè§ˆå™¨æ§åˆ¶å°ï¼‰
- âœ… åº”è¯¥çœ‹åˆ°: `[GlobalChat] WebSocket connected successfully`
- âœ… åº”è¯¥çœ‹åˆ°: `[AppLayout] Initializing global chat service`
- âœ… åº”è¯¥çœ‹åˆ°: `[ChatRoom] Using existing messages from global service` (ç¬¬äºŒæ¬¡è¿›å…¥æ—¶)
- âŒ ä¸åº”çœ‹åˆ°: é¢‘ç¹çš„è¿æ¥/æ–­å¼€æ—¥å¿—

### åç«¯æ—¥å¿—
- âœ… åº”è¯¥çœ‹åˆ°: `Client connected`
- âœ… åº”è¯¥çœ‹åˆ°: `Replaced old connection` (å¿«é€Ÿé‡è¿æ—¶)
- âœ… åº”è¯¥çœ‹åˆ°: `Client disconnected`
- âŒ ä¸åº”çœ‹åˆ°: `panic: close of closed channel`
- âŒ ä¸åº”çœ‹åˆ°: é¢‘ç¹çš„æ­£å¸¸æ–­å¼€ï¼ˆé™¤éç”¨æˆ·çœŸçš„ç¦»å¼€é¡µé¢ï¼‰

### error.log æ–‡ä»¶
æ‰“å¼€ `shequ_gin/log/2025-10-29/error.log`:
- âŒ ä¸åº”å†å‡ºç°: `websocket: close 1000 (normal): Client disconnect` (é¢‘ç¹å‡ºç°)
- âŒ ä¸åº”å‡ºç°: panic é”™è¯¯

## âœ… éªŒæ”¶æ ‡å‡†

ä¿®å¤æˆåŠŸçš„æ ‡å¿—ï¼š
1. âœ… åç«¯æœåŠ¡å™¨å¯åŠ¨æ— é”™è¯¯
2. âœ… å‰ç«¯å¯ä»¥æ­£å¸¸ç™»å½•å’Œä½¿ç”¨èŠå¤©åŠŸèƒ½
3. âœ… å¿«é€Ÿåˆ·æ–°é¡µé¢ä¸ä¼šå¯¼è‡´åç«¯ panic
4. âœ… åœ¨èŠå¤©é¡µé¢é—´åˆ‡æ¢ä¸ä¼šé¢‘ç¹æ–­å¼€è¿æ¥
5. âœ… error.log ä¸­æ²¡æœ‰ panic é”™è¯¯
6. âœ… æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º WebSocket æŒä¹…è¿æ¥

## ğŸ› å¦‚æœä»æœ‰é—®é¢˜

### 1. æ¸…é™¤æ—§æ—¥å¿—
```bash
cd shequ_gin/log/2025-10-29
del *.log
```

### 2. é‡æ–°ç¼–è¯‘
```bash
cd shequ_gin
go build -o build/app.exe .
```

### 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- æŒ‰ Ctrl+Shift+Delete
- æ¸…é™¤ç¼“å­˜å’Œ Cookie
- é‡æ–°ç™»å½•

### 4. æ£€æŸ¥é…ç½®
ç¡®è®¤ `shequ_gin/config.yaml` é…ç½®æ­£ç¡®ï¼š
```yaml
server:
  port: 3001
  mode: debug  # æˆ– release
```

## ğŸ“ é—®é¢˜æ’æŸ¥

å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·æä¾›ï¼š
1. åç«¯æ—¥å¿— (`shequ_gin/log/2025-10-29/error.log`)
2. æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—ï¼ˆF12 > Consoleï¼‰
3. å…·ä½“çš„æ“ä½œæ­¥éª¤
4. é”™è¯¯æˆªå›¾

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-29  
**ä¿®å¤æ–‡ä»¶**: 
- å‰ç«¯: `src/services/globalChatService.ts`, `src/views/auth/LoginView.vue`, `src/views/chat/*.vue`, `src/layouts/AppLayout.vue`
- åç«¯: `internal/handlers/websocket_chat.go`

